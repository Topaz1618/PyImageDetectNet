{% extends 'layout/detection_common.html' %}


{% block title %}
<title> 识别结果分析 </title>
{% end %}

{% block content %}

<div style="width: 86%; margin-left: 10.5%; margin-top: 5%">
        <h3>识别结果分析</h3>
    <ul class="custom-list" style=" margin-top: 2%">
        <li style="list-style: none;  padding: 10px; margin-bottom: 10px; ">
            <button class="span_button modal-title info" style="width: 3%;font-size: 0.9rem; "> ID </button>
            <button class="span_button modal-title info" style="width: 12%;font-size: 0.9rem; "> 档案编号 </button>
            <button class="span_button modal-title info" style="width: 10%;font-size: 0.9rem;"> 户口本检测结果 </button>
            <button class="span_button modal-title info" style="width: 5%;font-size: 0.9rem;"> 图片 </button>
            <button class="span_button modal-title info" style="width: 10%;font-size: 0.9rem;"> 宗地图检测结果 </button>
            <button class="span_button modal-title info" style="width: 5%;font-size: 0.9rem;"> 图片 </button>
            <button class="span_button modal-title info" style="width: 10%;font-size: 0.9rem;"> 房屋平面图检测结果 </button>
            <button class="span_button modal-title info" style="width: 5%;font-size: 0.9rem;"> 图片 </button>
            <button class="span_button modal-title info" style="width: 10%;font-size: 0.9rem;"> 身份证检测结果 </button>
            <button class="span_button modal-title info" style="width: 5%;font-size: 0.9rem;"> 图片 </button>
            <button class="span_button modal-title info" style="width: 10%;font-size: 0.9rem;"> 不动产登记表检测结果 </button>
            <button class="span_button modal-title info" style="width: 5%;font-size: 0.9rem;"> 图片 </button>
        </li>
<!--        {{ task_list }}-->

        {% for  index, item in enumerate(task_list) %}

        <li style=" padding: 10px; margin-bottom: 10px;   ">

            <button class="modal-title  span_button" style="; width: 3%; color: #e62246cc;font-weight: normal;font-size: 0.9rem; "> {{ index + 1 }}</button>
            <button class="modal-title  span_button" style="; width: 12%; font-weight: normal;font-size: 0.9rem; "> {{ item["detect_folder"] }}</button>

<!--            {{ item['res'] }}-->
            {% if item is not None and item['res'] is not None %}
                {% set my_dict = string_to_dict(item['res']) %}

                {% set res = res_dict(my_dict) %}


                {% if res is not None %}
                     "Aa" --- {{ res }}
                {% for single_res in res %}
                    {% set Wanna = ["户口本", "宗地图", "房屋平面图", "不动产申请表", "身份证"] %}

                    {% for key in Wanna %}
                         {% if key in single_res %}
                             <button class="modal-title  span_button" style="; width: 10%; font-weight: normal;font-size: 0.9rem; "> {{ single_res }}</button>
                             <button class="modal-title  span_button" style="; width: 5%; font-weight: normal;font-size: 0.9rem; "> 图片 </button>

                         {%else %}
                              <button class="modal-title  span_button" style="; width: 10%; font-weight: normal;font-size: 0.9rem; "> 1  </button>
                              <button class="modal-title  span_button" style="; width: 5%; font-weight: normal;font-size: 0.9rem; "> 2 </button>

                    {% end %}

<!--                {% end %}-->

            {% end %}
            {% end %}

            {% end %}


            <button class="span_confirm"  style="" onclick="DeleteDetectionTask(this)" data-task-id="{{ item['task_id'] }}" >
                <span class="mdi-delete"></span>
            </button>

        </li>
        {% end %}
    </ul>
</div>
{% end %}

{% block js %}
<script src="/static/task/js/jquery-3.6.0.min.js"></script>
<script src="/static/task/js/crypto-js.min.js"></script>
<script>

    const secretKey = 'YourSecretKey123'; // Replace this with your secret key
    function showTooltip(element) {
        var tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        tooltip.innerHTML = '点击查看结果';
        element.appendChild(tooltip);
        element.addEventListener('mousemove', function (e) {
            tooltip.style.left = e.clientX + 'px';
            tooltip.style.top = e.clientY + 100 + 'px';
        });
        tooltip.style.display = 'block';

    }

    function hideTooltip(element) {
        var tooltip = element.querySelector('.tooltip');
        if (tooltip) {
            tooltip.style.display = 'none';
            element.removeChild(tooltip);
        }
    }

    function decryptData(encryptedData) {
        var key = CryptoJS.enc.Utf8.parse(secretKey);
        var ciphertext = CryptoJS.enc.Base64.parse(encryptedData);

        // Get the IV by taking the first 16 bytes
        var iv = ciphertext.clone();
        iv.sigBytes = 16; // Set IV length to 16 bytes
        iv.clamp(); // Remove ciphertext leaving only IV'
        console.log("ciphertext", ciphertext)
        console.log("iv", iv)
        console.log("ciphertext", ciphertext)

        ciphertext.words.splice(0, 4); // Remove IV from ciphertext
        ciphertext.sigBytes -= 16; // Adjust ciphertext length
        console.log("ciphertext2", ciphertext)

        // Perform decryption
        var decrypted = CryptoJS.AES.decrypt({ ciphertext: ciphertext }, key, {
            iv: iv,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7});

        const decryptedData = new Uint8Array(decrypted.sigBytes);
        for (let i = 0; i < decrypted.sigBytes; i++) {
            decryptedData[i] = decrypted.words[i >>> 2] >>> (24 - (i % 4) * 8) & 0xff;
        }

        return decryptedData;
    }


    function UpdateProcessBar(chunk, chunks) {
        let percentage = (chunk / chunks) * 100;
        percentage = percentage.toFixed(2);
        var progressBarFill = document.getElementById("progress-bar-fill");
        progressBarFill.style.width = percentage + "%";
        progressBarFill.innerHTML = percentage + "%";

    }

    function UpdateProcessBarFull(){
        var percentage = 100
        var progressBarFill = document.getElementById("progress-bar-fill");
        progressBarFill.style.width = percentage + "%";
        progressBarFill.innerHTML = percentage + "%";
    }


    function DownloadFile(obj){
        console.log(obj.getAttribute("data-dataset-name"), obj.getAttribute("data-username"))


        var slices = [];
        var dataset_name = obj.getAttribute("data-dataset-name");
        var username = obj.getAttribute("data-username");
        var total_chunks = obj.getAttribute("data-chunks");
        var filename = obj.getAttribute("data-filename")


        var fileUrl = `download_dataset?dataset_name=${dataset_name}&username=${username}`;

        function downloadChunk(ChunkNumber) {
        $.ajax({
            url: fileUrl,
            type: 'GET',
            headers: {
                'X-Chunk-Number': ChunkNumber,
            },
            processData: false,
            success: function (chunk) {
                chunk = chunk.split("==== End Encryption ====")[0];
                console.log("chunk length", chunk.length, chunk, "idx:", ChunkNumber)
                var decryptedData = decryptData(chunk);
                console.log("Decrypted data length:", decryptedData.length);

                slices.push(decryptedData);

                ChunkNumber += 1;

                if (ChunkNumber < total_chunks) {
                    downloadChunk(ChunkNumber);
                    UpdateProcessBar(ChunkNumber, total_chunks);
                } else {
                    UpdateProcessBarFull();

                    var blob = new Blob(slices, {type: 'application/octet-stream'});
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);

                }
            }
        });
        }

        downloadChunk(0)
    }

    function DeleteDetectionTask(obj){
        console.log("!!!!! DeleteDetectionTask");
        var task_id = obj.getAttribute("data-task-id");

        var formData = new FormData();

        // 将数据添加到 FormData
        formData.append('task_id', task_id);
        console.log("task_id", task_id)

        // 发送 FormData 到后端
        fetch('/user/delete_detection_task', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          // 处理响应
          console.log('FormData 已发送到后端');
            if (response.status === 200) {
              // 刷新页面
              window.location.reload();
            }
        })
        .catch(error => {
          // 错误处理
          console.error('发送 FormData 到后端时出错:', error);
        });

    }

</script>

{% end %}